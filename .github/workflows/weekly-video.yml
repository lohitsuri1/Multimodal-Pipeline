name: Weekly Devotional Video Generation

on:
  # Run every Sunday at 6:00 AM UTC
  schedule:
    - cron: '0 6 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  generate-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
          PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY=${{ secrets.PIXABAY_API_KEY }}
          VIDEO_DURATION_MINUTES=30
          OUTPUT_DIR=output_videos
          TEMP_DIR=temp_files
          VOICE_LANGUAGE=en
          VOICE_SPEED=0.9
          MUSIC_VOLUME=0.2
          EOF
      
      - name: Generate devotional video
        run: |
          python devotional_pipeline.py
      
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: devotional-video-${{ github.run_number }}
          path: output_videos/*.mp4
          retention-days: 30
      
      - name: Upload script artifact
        uses: actions/upload-artifact@v4
        with:
          name: devotional-script-${{ github.run_number }}
          path: output_videos/*.txt
          retention-days: 30
      
      - name: Clean up temp files
        if: always()
        run: |
          rm -rf temp_files
